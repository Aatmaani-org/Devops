pipeline{
    agent any

    stages {
        stage ('mkdir & clone prod') {
	    steps{
	        sh ''' # mkdir Production 
	        cd Production
	        git clone https://github.com/Aatmaani-org/Production.git
                cd /var/lib/jenkins/workspace/sharan/nodejs-prod/Production/Production
	        aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 883195043912.dkr.ecr.us-west-2.amazonaws.com 
                docker build -t new-nodejs . 
		docker tag new-nodejs:latest 883195043912.dkr.ecr.us-west-2.amazonaws.com/new-nodejs:brocode 
		docker push 883195043912.dkr.ecr.us-west-2.amazonaws.com/new-nodejs:brocode '''
            }
	}
        stage('helm run'){
	    steps{
	        sh '''pwd
                cd /var/lib/jenkins/workspace/sharan/nodejs-prod/Sharan 
	        helm upgrade --install sharan-dev nodejs -n sharan-dev -f values-dev.yaml'''
	     }
        }
    }

    post { 
      success{
        slackSend channel: 'project-team', message: 'success'
      }
      
      failure{
        slackSend channel: 'project-team', message: 'job-failed'                                                                                                                                                            }
   }
}
